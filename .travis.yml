language: c
services:
    - docker

addons:
    artifacts:
        target_paths:
            - /dumb-init/${TRAVIS_BUILD_NUMBER}/${ITEST_TARGET}-${TRAVIS_OS_NAME}
        paths:
            - $(find dist -type f | tr "\n" ':')

matrix:
    include:
        - env: ITEST_TARGET=itest_trusty
        - env: ITEST_TARGET=itest_xenial
        - env: ITEST_TARGET=itest_bionic
        - env: ITEST_TARGET=itest_stretch
        - env: ITEST_TARGET=itest_tox
        - os: linux-ppc64le
          env: ITEST_TARGET=itest_stretch

script:
   - make "$ITEST_TARGET"

after_script:
   - if [ -n "${ARTIFACTS_SECRET:-}" ]; then
         echo 'Build artifacts are available at:';
         find dist -type f | xargs --replace echo "* https://yelp-travis-artifacts.s3.amazonaws.com/dumb-init/${TRAVIS_BUILD_NUMBER}/${ITEST_TARGET}/{}";
     fi
